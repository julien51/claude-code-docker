#!/bin/bash
# ABOUTME: Launches or reattaches to a named interactive Claude session.
# ABOUTME: Syncs credentials back from the container after detach/exit.

cd ~/claude-docker

# Load environment variables
set -a
source .env
set +a

# Helper: copy credentials from a container's session volume back to shared-config
sync_credentials_from() {
    local container="$1"
    local dest="$HOME/claude-docker/claude-config/.claude/.credentials.json"
    docker cp "${container}:/home/claude/.claude/.credentials.json" "$dest" 2>/dev/null && \
        echo "Synced credentials from ${container}." || true
}

# Helper: push fresh credentials from shared-config into a running container
sync_credentials_into() {
    local container="$1"
    local src="$HOME/claude-docker/claude-config/.claude/.credentials.json"
    if [ -f "$src" ]; then
        docker cp "$src" "${container}:/home/claude/.claude/.credentials.json" 2>/dev/null && \
            docker exec "$container" chown claude:claude /home/claude/.claude/.credentials.json 2>/dev/null && \
            echo "Pushed fresh credentials into ${container}." || true
    fi
}

# Get session name from argument or generate timestamp
if [ -n "$1" ]; then
    SESSION_NAME="claude-session-$1"
else
    SESSION_NAME="claude-session-$(date +%Y%m%d-%H%M%S)"
fi

# Always sync fresh credentials from host into shared-config first
if [ -f "$HOME/.claude/.credentials.json" ]; then
    cp "$HOME/.claude/.credentials.json" "$HOME/claude-docker/claude-config/.claude/.credentials.json" 2>/dev/null || true
fi

# Check if session already exists
if docker ps --format '{{.Names}}' | grep -q "^$SESSION_NAME$"; then
    # Running — push fresh creds and attach
    echo "Session '$SESSION_NAME' is running. Attaching..."
    sync_credentials_into "$SESSION_NAME"
    docker attach "$SESSION_NAME"
    sync_credentials_from "$SESSION_NAME"
    exit $?
elif docker ps -a --format '{{.Names}}' | grep -q "^$SESSION_NAME$"; then
    # Stopped — restart, push fresh creds, attach
    echo "Restarting stopped session '$SESSION_NAME'..."
    docker start "$SESSION_NAME"
    sync_credentials_into "$SESSION_NAME"
    docker attach "$SESSION_NAME"
    sync_credentials_from "$SESSION_NAME"
    exit $?
fi

# Build image if it doesn't exist
if ! docker images | grep -q "claude-docker-claude-code"; then
    echo "Building Claude image..."
    docker compose build claude-code
fi

# Start new container in detached mode with unique name
# - Per-session volume for /home/claude (isolated session state)
# - Shared config bind mount (read-only) for credentials and settings
echo "Starting new Claude session: $SESSION_NAME"
docker run -d \
    --name "$SESSION_NAME" \
    -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
    -e GITHUB_TOKEN="$GITHUB_TOKEN" \
    -v "$HOME/claude-docker/workspace:/workspace" \
    -v "${SESSION_NAME}:/home/claude" \
    -v "$HOME/claude-docker/claude-config:/shared-config:ro" \
    -w /workspace \
    --cpus 1 \
    --memory 2g \
    -it \
    claude-docker-claude-code

# Attach to the container
echo "Attaching to $SESSION_NAME..."
docker attach "$SESSION_NAME"
sync_credentials_from "$SESSION_NAME"
